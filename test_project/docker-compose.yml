version: '3.3'

x-logging: &default-logging
  options:
    max-size: "10M"
    max-file: "10" 
  driver: json-file

services:
  app:
    hostname: fastpg_app
    build:
      context: .
      dockerfile: ./dockerify/Dockerfile
    ports:
      - '18092:8092'
    env_file: secrets.env
    volumes:
      - .:/app/code
    depends_on:
      - db
      - db_replica
    logging: *default-logging
    command: uvicorn app.main:app --host 0.0.0.0 --port 8092 --log-level info --reload

  db:
    build:
      context: .
      dockerfile: ./dockerify/db/pg13/Dockerfile
    volumes:
      - fastpg_db:/var/lib/postgresql/data
    ports:
      - '0.0.0.0:17432:5432'
    env_file:
      - secrets.env
    environment:
      - POSTGRES_REPLICATION_USER=replicator
      - POSTGRES_REPLICATION_PASSWORD=repl_password_123
    command: >
      postgres
      -c wal_level=replica
      -c max_wal_senders=3
      -c max_replication_slots=3
      -c hot_standby=on

  db_replica:
    image: postgres:13.5
    volumes:
      - fastpg_db_replica:/var/lib/postgresql/data
      - ./dockerify/db/pg13/replica-entrypoint.sh:/replica-entrypoint.sh:ro
    ports:
      - '0.0.0.0:17433:5432'
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=ASd78hASlpmvC8vbd
      - POSTGRES_DB=fastpg_db
      - PRIMARY_HOST=db
      - PRIMARY_PORT=5432
      - REPLICATION_USER=replicator
      - REPLICATION_PASSWORD=repl_password_123
    depends_on:
      - db
    command: ["/bin/bash", "/replica-entrypoint.sh"]

volumes:
  fastpg_db:
    driver: local
  fastpg_db_replica:
    driver: local